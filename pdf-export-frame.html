<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Export Frame</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <script>
    let pdf;
    let currentPage = 0;
    const pages = [];

    // Receive screenshot data from Wix
    window.addEventListener("message", async (event) => {
      const { type, data, orientation } = event.data || {};

      if (type === "pdf-frame-ready") {
        // Tell Wix we're ready to receive screenshots
        parent.postMessage({ type: "next-page" }, "*");

      } else if (type === "render-page") {
        // Receive a page image and store it
        pages.push({ data, orientation });
        currentPage++;
        parent.postMessage({ type: "next-page" }, "*");

      } else if (type === "render-complete") {
        // All pages received â€“ begin PDF generation
        pdf = new jspdf.jsPDF({ format: "a5", orientation: pages[0].orientation || "portrait" });

        pages.forEach((page, index) => {
          const { data, orientation } = page;
          if (index > 0) pdf.addPage("a5", orientation);
          pdf.addImage(data, "JPEG", 0, 0, orientation === "landscape" ? 210 : 148, 210);
        });

        pdf.save("Tangihanga-Service-Sheet.pdf");
        parent.postMessage({ type: "done" }, "*");
      }
    });

    // Confirm ready to parent
    window.parent.postMessage({ type: "pdf-frame-ready" }, "*");
  </script>
</body>
</html>
