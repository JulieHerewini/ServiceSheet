<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Template Export</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: white;
      font-family: sans-serif;
    }
    .page {
      display: none;
      padding: 20px;
      box-sizing: border-box;
      background: white;
    }
    .cover, .back {
      width: 420px;
      height: 595px;
    }
    .order {
      width: 842px;
      height: 595px;
    }
    .visible {
      display: block !important;
    }
  </style>
</head>
<body>
  <div id="coverPreviewBox" class="page cover"></div>
  <div id="orderPreviewBox" class="page order"></div>
  <div id="backPreviewBox" class="page back"></div>

  <script>
    const pages = {
      coverPreviewBox: { el: document.getElementById("coverPreviewBox"), orientation: "portrait" },
      orderPreviewBox: { el: document.getElementById("orderPreviewBox"), orientation: "landscape" },
      backPreviewBox: { el: document.getElementById("backPreviewBox"), orientation: "portrait" }
    };

    let renderedCanvases = [];

    window.addEventListener("message", async (event) => {
      const msg = event.data;

      if (msg?.type === "request-screenshot") {
        const { pageId } = msg;
        for (const id in pages) pages[id].el.classList.remove("visible");
        const page = pages[pageId];
        if (!page) return;

        page.el.classList.add("visible");

        await new Promise(resolve => setTimeout(resolve, 500)); // Wait for layout

        const canvas = await html2canvas(page.el, { scale: 2 });
        renderedCanvases.push({ canvas, orientation: page.orientation });

        parent.postMessage({ type: "next-page" }, "*");
      }

      if (msg?.type === "renderContent") {
        const { pageId, html } = msg;
        if (pages[pageId]) {
          pages[pageId].el.innerHTML = html;
        }
      }

      if (msg?.type === "render-complete") {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ unit: "px", format: "a5", orientation: "portrait" });

        renderedCanvases.forEach((entry, i) => {
          const imgData = entry.canvas.toDataURL("image/png");
          const width = entry.orientation === "landscape" ? 842 : 420;
          const height = 595;

          if (i > 0) pdf.addPage([width, height], entry.orientation);
          pdf.addImage(imgData, "PNG", 0, 0, width, height);
        });

        pdf.save("tangihanga-template.pdf");
        parent.postMessage({ type: "done" }, "*");
      }
    });

    // Notify Wix Lightbox weâ€™re ready
    window.onload = () => {
      parent.postMessage({ type: "pdf-frame-ready" }, "*");
    };
  </script>
</body>
</html>

