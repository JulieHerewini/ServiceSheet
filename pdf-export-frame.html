<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Export Frame</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: white;
    }
    #exportArea {
      width: 100%;
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <div id="exportArea"></div>

  <script>
    let htmlQueue = [];
    let pageCounter = 0;
    let ready = false;

    // Tell Wix we're ready to receive content
    window.addEventListener("message", async (event) => {
      const { type, html, orientation } = event.data;

      if (type === "ping") {
        ready = true;
        postMessageToWix({ type: "pdf-frame-ready" });

      } else if (type === "get-html") {
        postMessageToWix({ type: "get-html" });

      } else if (type === "renderContent") {
        const pageWrapper = document.createElement("div");
        pageWrapper.innerHTML = html;
        pageWrapper.style.pageBreakAfter = "always";
        pageWrapper.style.width = (orientation === "landscape") ? "1122px" : "794px";
        pageWrapper.style.height = (orientation === "landscape") ? "794px" : "1122px";
        htmlQueue.push(pageWrapper);
        pageCounter++;
        postMessageToWix({ type: "next-page" });

      } else if (type === "render-complete") {
        renderPDF();
      }
    });

    function postMessageToWix(data) {
      if (window.parent) {
        window.parent.postMessage(data, "*");
      }
    }

    async function renderPDF() {
      const container = document.getElementById("exportArea");
      htmlQueue.forEach(el => container.appendChild(el));

      const opt = {
        margin: 0,
        filename: 'ServiceSheet.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'px', format: 'a4', orientation: 'portrait' }
      };

      await html2pdf().set(opt).from(container).save();

      postMessageToWix({ type: "done" });
    }
  </script>
</body>
</html>
