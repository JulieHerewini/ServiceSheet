<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PDF Export Iframe</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    .pdf-page {
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div id="pdfContainer"></div>

  <script>
    const pages = [];
    const orientations = [];
    let currentIndex = 0;

    window.addEventListener("message", async (event) => {
      const data = event.data;
      if (!data || !data.type) return;

      if (data.type === "pdf-frame-ready") {
        parent.postMessage({ type: "pdf-frame-ready" }, "*");
      }

      if (data.type === "renderContent") {
        const container = document.getElementById("pdfContainer");
        const wrapper = document.createElement("div");
        wrapper.className = "pdf-page";
        wrapper.innerHTML = data.html || "<div>empty</div>";
        wrapper.id = data.pageId;
        container.appendChild(wrapper);
        pages.push(wrapper);
        orientations.push(data.orientation || "portrait");
        parent.postMessage({ type: "next-page" }, "*");
      }

      if (data.type === "render-complete") {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ orientation: orientations[0] || "portrait", unit: "px", format: "a4" });

          for (let i = 0; i < pages.length; i++) {
            const canvas = await html2canvas(pages[i], { scale: 2 });
            const imgData = canvas.toDataURL("image/jpeg", 1.0);
            const pageOrientation = orientations[i] || "portrait";
            const pageSize = pageOrientation === "landscape" ? [842, 595] : [595, 842];

            if (i > 0) doc.addPage(...pageSize, pageOrientation);
            doc.addImage(imgData, "JPEG", 0, 0, pageSize[0], pageSize[1]);
          }

          doc.save("tangihanga-template.pdf");
          parent.postMessage({ type: "done" }, "*");
        } catch (err) {
          console.error("PDF generation error:", err);
          parent.postMessage({ type: "done" }, "*");
        }
      }
    });
  </script>
</body>
</html>



