<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Export PDF</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }
    .pdf-page {
      width: 794px; /* A4 width at 96dpi */
      height: 1123px; /* A4 height at 96dpi */
      padding: 20px;
      box-sizing: border-box;
      background: white;
      overflow: hidden;
    }
    .landscape {
      width: 1123px;
      height: 794px;
    }
  </style>
</head>
<body>
  <div id="captureArea" style="visibility: hidden; position: absolute; top: -9999px;"></div>
  <script>
    const pages = {};
    let currentStep = 0;

    window.addEventListener("message", async (event) => {
      const { type, pageId, html, orientation } = event.data || {};

      if (type === "renderContent") {
        pages[pageId] = { html, orientation };
      }

      if (type === "request-screenshot") {
        const { jsPDF } = window.jspdf;
        const container = document.getElementById("captureArea");

        container.innerHTML = pages[pageId]?.html || "<div>[Unsupported element]</div>";
        container.className = "pdf-page" + (pages[pageId]?.orientation === "landscape" ? " landscape" : "");

        await new Promise(resolve => setTimeout(resolve, 100));

        html2canvas(container).then(canvas => {
          const imgData = canvas.toDataURL("image/jpeg", 1.0);

          if (!window._pdfDoc) {
            window._pdfDoc = new jsPDF(pages[pageId]?.orientation || "p", "pt", "a4");
          } else {
            window._pdfDoc.addPage();
            window._pdfDoc.setPage(window._pdfDoc.getNumberOfPages());
          }

          window._pdfDoc.addImage(imgData, "JPEG", 0, 0);
          window.parent.postMessage({ type: "next-page" }, "*");
        });
      }

      if (type === "render-complete") {
        if (window._pdfDoc) {
          window._pdfDoc.save("tangihanga-template.pdf");
        }
        window.parent.postMessage({ type: "done" }, "*");
      }

      if (type === "ping") {
        window.parent.postMessage({ type: "pdf-frame-ready" }, "*");
      }
    });

    // Send ping once frame is ready
    window.parent.postMessage({ type: "pdf-frame-ready" }, "*");
  </script>
</body>
</html>



