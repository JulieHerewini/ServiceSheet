<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PDF Export Frame</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body style="margin:0;padding:0;">
  <script>
    let pages = [];
    let currentPage = 0;

    window.addEventListener("message", async (event) => {
      const { type, html, pageId, orientation } = event.data;

      if (type === "ping") {
        parent.postMessage({ type: "pdf-frame-ready" }, "*");

      } else if (type === "get-html") {
        parent.postMessage({ type: "get-html" }, "*");

      } else if (type === "renderContent") {
        const container = document.createElement("div");
        container.innerHTML = html;
        container.style.width = "1000px";
        container.style.margin = "0 auto";
        document.body.innerHTML = '';
        document.body.appendChild(container);

        // Wait for images and fonts to load
        await new Promise(resolve => setTimeout(resolve, 1500));

        const pdf = new jspdf.jsPDF({ orientation: orientation || "portrait", unit: "px", format: [1000, 1414] });

        await pdf.html(container, {
          callback: (doc) => {
            const blob = doc.output("blob");
            pages.push(blob);
            parent.postMessage({ type: "next-page" }, "*");
          }
        });

      } else if (type === "render-complete") {
        if (pages.length > 0) {
          const mergedPdf = new jspdf.jsPDF({ unit: "px", format: [1000, 1414] });

          for (let i = 0; i < pages.length; i++) {
            if (i !== 0) mergedPdf.addPage();
            const page = await pages[i].arrayBuffer();
            await mergedPdf.addImage(await blobToBase64(new Blob([page])), 'PNG', 0, 0, 1000, 1414);
          }

          mergedPdf.save("ServiceSheet.pdf");
          parent.postMessage({ type: "done" }, "*");
        }
      }
    });

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
  </script>
</body>
</html>
