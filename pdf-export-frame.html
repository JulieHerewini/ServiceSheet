<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tangihanga PDF Export</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: white;
    }
    .page {
      display: none;
      width: 793px; /* A5 width at 96dpi */
      height: 1122px; /* A5 height at 96dpi */
      padding: 10px;
      box-sizing: border-box;
    }
    .landscape {
      width: 1122px; /* A4 width landscape */
      height: 793px;
    }
  </style>
</head>
<body>
  <div id="coverPreviewBox" class="page"></div>
  <div id="orderPreviewBox" class="page landscape"></div>
  <div id="backPreviewBox" class="page"></div>

  <script>
    const pages = [
      { id: "coverPreviewBox", format: "A5", orientation: "portrait" },
      { id: "orderPreviewBox", format: "A4", orientation: "landscape" },
      { id: "backPreviewBox", format: "A5", orientation: "portrait" }
    ];

    function wait(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function renderPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      for (let i = 0; i < pages.length; i++) {
        const { id, format, orientation } = pages[i];
        const pageEl = document.getElementById(id);
        if (!pageEl) continue;

        // Show only this page
        pages.forEach(p => {
          const el = document.getElementById(p.id);
          if (el) el.style.display = "none";
        });
        pageEl.style.display = "block";

        // Wait for rendering
        await wait(1000);

        const canvas = await html2canvas(pageEl);
        const imgData = canvas.toDataURL("image/png");

        if (i > 0) pdf.addPage(format, orientation);
        pdf.addImage(imgData, 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());

        window.parent.postMessage({ type: "progress", current: i + 1, total: pages.length }, "*");
      }

      pdf.save("Tangihanga-Service-Sheet.pdf");
      window.parent.postMessage({ type: "complete" }, "*");
    }

    window.addEventListener("message", (event) => {
      if (event.data?.type === "render-pdf") {
        renderPDF();
      }
    });

    console.log("âœ… PDF Export Frame Ready");
  </script>
</body>
</html>
