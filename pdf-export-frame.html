<script>
  const { jsPDF } = window.jspdf;
  const pages = [];

  window.addEventListener("message", async (event) => {
    const data = event.data;
    if (!data || !data.type) return;

    if (data.type === "request-screenshot") {
      const { pageId, orientation } = data;

      const target = document.getElementById(pageId);
      if (!target) {
        pages.push({ img: null, orientation }); // Push empty if missing
        parent.postMessage({ type: "next-page" }, "*");
        return;
      }

      try {
        const canvas = await html2canvas(target, { scale: 2 });
        const imgData = canvas.toDataURL("image/jpeg", 1.0);
        pages.push({ img: imgData, orientation });
        parent.postMessage({ type: "next-page" }, "*");
      } catch (err) {
        console.error("Error capturing screenshot:", err);
        pages.push({ img: null, orientation });
        parent.postMessage({ type: "next-page" }, "*");
      }
    }

    if (data.type === "render-complete") {
      const pdf = new jsPDF();
      pages.forEach((page, index) => {
        const { img, orientation } = page;
        if (!img) return;

        if (index > 0) pdf.addPage(orientation === "landscape" ? "l" : "p");
        pdf.setPage(index + 1);

        const width = orientation === "landscape" ? 297 : 210;
        const height = orientation === "landscape" ? 210 : 297;
        pdf.addImage(img, "JPEG", 0, 0, width, height);
      });

      pdf.save("template-download.pdf");
      parent.postMessage({ type: "done" }, "*");
    }
  });

  window.parent.postMessage({ type: "pdf-frame-ready" }, "*");
</script>
