<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Export Frame</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    .rendered-page {
      width: 100%;
      min-height: 100vh;
      padding: 30px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div id="pageRenderer" class="rendered-page"></div>
  <script>
    const { jsPDF } = window.jspdf;
    const renderedPages = {};
    let renderQueue = [];

    function receiveMessage(event) {
      const msg = event.data;
      if (!msg || !msg.type) return;

      if (msg.type === "request-screenshot") {
        parent.postMessage({ type: "pdf-frame-ready" }, "*");
      }

      else if (msg.type === "renderContent") {
        const { pageId, html } = msg;
        renderedPages[pageId] = html;
      }

      else if (msg.type === "render-complete") {
        renderQueue = Object.entries(renderedPages);
        renderNextPage([]);
      }
    }

    async function renderNextPage(images) {
      if (renderQueue.length === 0) {
        const pdf = new jsPDF();
        images.forEach((img, index) => {
          if (index > 0) pdf.addPage();
          pdf.addImage(img, "PNG", 10, 10, 190, 277);
        });
        pdf.save("Tangihanga_Template.pdf");
        parent.postMessage({ type: "done" }, "*");
        return;
      }

      const [pageId, html] = renderQueue.shift();
      const container = document.getElementById("pageRenderer");
      container.innerHTML = html;

      await new Promise(r => setTimeout(r, 300));

      const canvas = await html2canvas(container);
      const imgData = canvas.toDataURL("image/png");
      renderNextPage([...images, imgData]);
    }

    window.addEventListener("message", receiveMessage);
  </script>
</body>
</html>
