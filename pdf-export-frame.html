<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>PDF Export Frame</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    .page {
      display: none;
    }
    .rendering {
      display: block;
    }
  </style>
</head>
<body>
  <div id="coverPreviewBox" class="page" style="width: 420px; height: 595px;"></div> <!-- A5 portrait -->
  <div id="orderPreviewBox" class="page" style="width: 842px; height: 595px;"></div> <!-- A4 landscape -->
  <div id="backPreviewBox" class="page" style="width: 420px; height: 595px;"></div> <!-- A5 portrait -->

  <script>
    const pages = ["coverPreviewBox", "orderPreviewBox", "backPreviewBox"];
    const pageSizes = {
      coverPreviewBox: [148, 210],   // A5 portrait in mm
      orderPreviewBox: [297, 210],   // A4 landscape in mm
      backPreviewBox: [148, 210]     // A5 portrait in mm
    };
    const htmlStore = {};

    window.addEventListener("message", async (event) => {
      const msg = event.data;

      if (msg?.type === "renderContent" && msg.pageId && msg.html) {
        const container = document.getElementById(msg.pageId);
        if (container) {
          container.innerHTML = msg.html;
        }
      }

      if (msg?.type === "render-complete") {
        generatePDF();
      }

      if (msg?.type === "request-screenshot") {
        const { pageId } = msg;
        pages.forEach(id => {
          document.getElementById(id).classList.remove("rendering");
        });
        const el = document.getElementById(pageId);
        if (el) {
          el.classList.add("rendering");
          setTimeout(async () => {
            await captureAndStore(pageId, el);
            parent.postMessage({ type: "next-page" }, "*");
          }, 500);
        }
      }
    });

    async function captureAndStore(pageId, element) {
      const canvas = await html2canvas(element, { scale: 2 });
      htmlStore[pageId] = canvas.toDataURL("image/png");
    }

    async function generatePDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      let first = true;
      for (const id of pages) {
        const img = htmlStore[id];
        const [w, h] = pageSizes[id]; // mm
        if (!first) pdf.addPage([w, h], "portrait");
        pdf.setPage(pages.indexOf(id) + 1);
        pdf.addImage(img, "PNG", 0, 0, w, h);
        first = false;
      }

      pdf.save("ServiceSheet.pdf");
      parent.postMessage({ type: "done" }, "*");
    }

    // Notify lightbox that we're ready
    window.parent.postMessage({ type: "pdf-frame-ready" }, "*");
  </script>
</body>
</html>
