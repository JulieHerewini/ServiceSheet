import wixData from 'wix-data';
import wixWindow from 'wix-window';

const previewSelectors = {
  cover: "#coverPreviewBox",
  order: "#orderPreviewBox",
  back: "#backPreviewBox"
};

let currentPageIndex = 0;
const flipPages = ["#coverPreviewBox", "#orderPreviewBox", "#backPreviewBox"];
let extractedHtml = {};

function showPage(index) {
  flipPages.forEach((selector, i) => {
    const box = $w(selector);
    if (i === index) box.show();
    else box.hide();
  });
}

function sendCurrentPageToIframe() {
  const pageId = flipPages[currentPageIndex].replace("#", "");
  const orientation = pageId === "orderPreviewBox" ? "landscape" : "portrait";

  $w("#htmlPdfExportFrameFinal").postMessage({
    type: "request-screenshot",
    pageId,
    orientation
  });
}

async function extractHtmlFromPreview(selector, key) {
  return new Promise((resolve) => {
    $w("#htmlExtractorFrame").onMessage((event) => {
      const data = event.data;
      if (data?.type === "outerHTML" && data.selector === selector) {
        extractedHtml[key] = data.html;
        resolve();
      }
    });
    $w("#htmlExtractorFrame").postMessage({ type: "getOuterHTML", selector });
  });
}

$w.onReady(async () => {
  $w("#downloadStatusText").hide();
  $w("#downloadProgressBar").hide();
  flipPages.forEach(id => $w(id).hide());

  $w("#htmlPdfExportFrameFinal").onMessage(async (event) => {
    const msg = event.data?.type;

    if (msg === "pdf-frame-ready") {
      // Extract actual visual HTML from visible Wix containers
      await extractHtmlFromPreview(previewSelectors.cover, "coverPreviewBox");
      await extractHtmlFromPreview(previewSelectors.order, "orderPreviewBox");
      await extractHtmlFromPreview(previewSelectors.back, "backPreviewBox");

      // Send that HTML to the GitHub PDF export iframe
      Object.entries(extractedHtml).forEach(([pageId, html]) => {
        $w("#htmlPdfExportFrameFinal").postMessage({
          type: "renderContent",
          pageId,
          html
        });
      });

      // Start screenshot + merge
      currentPageIndex = 0;
      showPage(currentPageIndex);
      sendCurrentPageToIframe();
    }

    else if (msg === "next-page") {
      currentPageIndex++;
      if (currentPageIndex < flipPages.length) {
        showPage(currentPageIndex);
        setTimeout(() => sendCurrentPageToIframe(), 400);
      } else {
        $w("#htmlPdfExportFrameFinal").postMessage({ type: "render-complete" });
      }
    }

    else if (msg === "done") {
      $w("#downloadStatusText").text = "Download complete!";
      $w("#downloadProgressBar").hide();
      setTimeout(() => wixWindow.lightbox.close(), 2000);
    }
  });

  const context = wixWindow.lightbox.getContext();
  const templateId = context?.templateId;

  if (!templateId) {
    console.error("No templateId provided to PDFDownloadLightbox");
    $w("#downloadStatusText").text = "Template not found.";
    $w("#downloadStatusText").show();
    return;
  }

  try {
    const item = await wixData.get("FuneralServiceSheetTemplate", templateId);

    // COVER
    $w("#coverPageNameDisplay").text = item.name || "";
    $w("#coverPageDatesDisplay").text = item.date || "";
    $w("#coverPagePhotoDisplay").src = item.mainImage || "";

    // ORDER
    $w("#mihiSpeakerInput").text = item.mihi || "";
    $w("#karakia1SpeakerInput").text = item.karakia || "";
    $w("#readingSpeakerInput").text = item.readings || "";
    $w("#eulogySpeakerInput").text = item.eulogy || "";
    $w("#kauhauSpeakerInput").text = item.kauhau || "";
    $w("#karakia2SpeakerInput").text = item.closingKarakia || "";

    // WAIATA
    for (let i = 1; i <= 4; i++) {
      const waiataId = item[`waiata${i}`];
      const htmlComp = $w(`#waiata${i}DisplayFrame`);
      if (waiataId && htmlComp) {
        try {
          const waiataItem = await wixData.get("Waiata", waiataId);
          const waiataHtml = waiataItem.waiataContent || "<p>No content</p>";
          setTimeout(() => {
            htmlComp.postMessage({ type: "renderContent", html: waiataHtml, pageId: htmlComp.id });
          }, 500);
          htmlComp.show();
        } catch {
          htmlComp.hide();
        }
      } else {
        htmlComp.hide();
      }
    }

    // BACK COVER
    $w("#backCoverReceptionDisplay").text = item.receptionInfo || "";
    if (Array.isArray(item.photos)) {
      $w("#backCoverPhotoDisplay").items = item.photos.map(url => ({ type: "image", src: url }));
    }

    await new Promise(resolve => setTimeout(resolve, 1500)); // Allow for full render

    $w("#downloadStatusText").text = "Preparing downloadâ€¦";
    $w("#downloadStatusText").show();
    $w("#downloadProgressBar").show();

  } catch (err) {
    console.error("PDF Lightbox Error:", err);
    $w("#downloadStatusText").text = "An unexpected error occurred.";
    $w("#downloadStatusText").show();
  }
});
