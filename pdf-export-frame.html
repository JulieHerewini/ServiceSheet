<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Export Frame</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: white;
    }

    .rendered-page {
      box-sizing: border-box;
      overflow: hidden;
      page-break-after: always;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .a5-portrait {
      width: 420pt;
      height: 595pt;
    }

    .a4-landscape {
      width: 841.89pt;
      height: 595.28pt;
    }

    #pageContainer {
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body>
  <div id="pageContainer"></div>

  <script>
    const { jsPDF } = window.jspdf;
    const pageContainer = document.getElementById("pageContainer");

    const pages = {};
    const pageOrder = [];
    const pageSizes = {
      coverPreviewBox: { width: 420, height: 595, class: "a5-portrait" },
      orderPreviewBox: { width: 841.89, height: 595.28, class: "a4-landscape" },
      backPreviewBox: { width: 420, height: 595, class: "a5-portrait" }
    };

    window.addEventListener("message", async (event) => {
      const data = event.data;

      if (data?.type === "renderContent" && data.pageId && data.html) {
        const size = pageSizes[data.pageId] || pageSizes.coverPreviewBox;
        const wrapper = document.createElement("div");
        wrapper.className = `rendered-page ${size.class}`;
        wrapper.id = `rendered-${data.pageId}`;
        wrapper.innerHTML = data.html;

        pages[data.pageId] = { element: wrapper, size };
        pageOrder.push(data.pageId);
        console.log(`Injected ${data.pageId}`);
      }

      if (data?.type === "render-complete") {
        pageOrder.forEach(id => {
          const page = pages[id];
          pageContainer.appendChild(page.element);
        });
        console.log("All pages appended. Generating PDF...");
        await generatePDF();
      }

      if (data?.type === "request-screenshot") {
        event.source.postMessage({ type: "pdf-frame-ready" }, "*");
      }
    });

    async function generatePDF() {
      const pdf = new jsPDF({ unit: "pt", format: "a4", orientation: "portrait" });

      for (let i = 0; i < pageOrder.length; i++) {
        const pageId = pageOrder[i];
        const { element, size } = pages[pageId];

        const canvas = await html2canvas(element, {
          scale: 2,
          useCORS: true
        });

        const imgData = canvas.toDataURL("image/jpeg", 1.0);
        if (i > 0) pdf.addPage([size.width, size.height]);
        pdf.setPage(i + 1);
        pdf.addImage(imgData, "JPEG", 0, 0, size.width, size.height);
        console.log(`Rendered ${pageId}`);
      }

      pdf.save("funeral-service-booklet.pdf");
      window.parent.postMessage({ type: "done" }, "*");
    }
  </script>
</body>
</html>

