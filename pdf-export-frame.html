<script>
  let htmlPages = [];
  let currentStep = "";

  window.addEventListener("message", async (event) => {
    const { type, html, pageId, orientation } = event.data;

    console.log("üì© Received:", type);

    if (type === "ping") {
      console.log("‚úÖ Pinging back to parent...");
      parent.postMessage({ type: "pdf-frame-ready" }, "*");
    }

    else if (type === "renderContent") {
      console.log(`üñºÔ∏è Rendering ${pageId} (${orientation})`);
      
      // Show current HTML visibly
      document.body.innerHTML = html;

      // Store for PDF later
      htmlPages.push({ html, orientation });

      // Wait for user to see the page before cycling
      await new Promise(r => setTimeout(r, 1200));
      parent.postMessage({ type: "next-page" }, "*");
    }

    else if (type === "render-complete") {
      console.log("üì¶ Rendering complete. Compiling PDF‚Ä¶");
      const container = document.createElement("div");

      htmlPages.forEach(page => {
        const pageDiv = document.createElement("div");
        pageDiv.className = `page ${page.orientation}`;
        pageDiv.innerHTML = page.html;
        container.appendChild(pageDiv);
      });

      document.body.innerHTML = ""; // Clear before PDF render
      document.body.appendChild(container);

      try {
        const opt = {
          margin: 0,
          filename: "Tangihanga_Template.pdf",
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
        };

        await html2pdf().from(container).set(opt).save();
        parent.postMessage({ type: "done" }, "*");
      } catch (err) {
        console.error("‚ùå PDF generation error:", err);
        parent.postMessage({ type: "done" }, "*");
      }
    }

    // If your parent uses this:
    else if (type === "get-html") {
      parent.postMessage({
        type: "html-content",
        html: document.body.innerHTML
      }, "*");
    }
  });
</script>







