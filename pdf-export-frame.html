<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Export Frame</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    .rendered-page {
      width: 100%;
      min-height: 100vh;
      box-sizing: border-box;
      padding: 20px;
      font-family: sans-serif;
    }
    .a5 { width: 148mm; height: 210mm; }
    .a4-landscape { width: 297mm; height: 210mm; }
  </style>
</head>
<body>
  <div id="renderArea"></div>

  <script>
    const renderArea = document.getElementById("renderArea");
    let pages = [];
    let currentIndex = 0;

    window.addEventListener("message", async (event) => {
      const { type, pageId, html, orientation } = event.data || {};

      if (type === "renderContent") {
        const wrapper = document.createElement("div");
        wrapper.className = `rendered-page ${orientation === "landscape" ? "a4-landscape" : "a5"}`;
        wrapper.id = pageId;
        wrapper.innerHTML = html || "<div>No content</div>";
        renderArea.appendChild(wrapper);
        pages.push(wrapper);
      }

      if (type === "render-complete") {
        await generatePdf();
      }

      if (type === "request-screenshot") {
        parent.postMessage({ type: "next-page" }, "*");
      }
    });

    async function generatePdf() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      for (let i = 0; i < pages.length; i++) {
        const page = pages[i];
        const canvas = await html2canvas(page, {
          scale: 2,
          backgroundColor: "#ffffff"
        });
        const imgData = canvas.toDataURL("image/jpeg", 1.0);
        const orientation = page.classList.contains("a4-landscape") ? "landscape" : "portrait";
        const width = orientation === "landscape" ? 297 : 148;
        const height = 210;

        if (i !== 0) pdf.addPage([width, height], orientation);
        pdf.setPage(i + 1);
        pdf.addImage(imgData, "JPEG", 0, 0, width, height);
      }

      pdf.save("funeral-service-booklet.pdf");
      parent.postMessage({ type: "done" }, "*");
    }

    parent.postMessage({ type: "pdf-frame-ready" }, "*");
  </script>
</body>
</html>

