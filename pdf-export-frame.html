<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Export Frame</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }
    .page {
      width: 100%;
      height: 100%;
      box-sizing: border-box;
    }
    .portrait {
      width: 148mm;
      height: 210mm;
    }
    .landscape {
      width: 297mm;
      height: 210mm;
    }
  </style>
</head>
<body>
  <script>
    const { jsPDF } = window.jspdf;
    const pages = {};
    const orientations = {};

    window.addEventListener("message", async (event) => {
      const msg = event.data;

      if (msg.type === "renderContent") {
        const container = document.createElement("div");
        container.className = `page ${msg.orientation || 'portrait'}`;
        container.id = msg.pageId;
        container.innerHTML = msg.html;
        document.body.appendChild(container);
        pages[msg.pageId] = container;
        orientations[msg.pageId] = msg.orientation;

        setTimeout(() => {
          parent.postMessage({ type: "waiata-ready", pageId: msg.pageId }, "*");
        }, 300);
      }

      if (msg.type === "request-screenshot") {
        const page = pages[msg.pageId];
        if (!page) return;

        await new Promise(resolve => setTimeout(resolve, 100));
        html2canvas(page).then(canvas => {
          const imgData = canvas.toDataURL("image/png");
          page.dataset.img = imgData;
          parent.postMessage({ type: "next-page" }, "*");
        });
      }

      if (msg.type === "render-complete") {
        const pdf = new jsPDF({ unit: "mm", format: "a5" });
        const keys = Object.keys(pages);

        keys.forEach((key, index) => {
          const imgData = pages[key].dataset.img;
          const orientation = orientations[key];

          const isLandscape = orientation === "landscape";
          const width = isLandscape ? 297 : 148;
          const height = 210;

          if (index !== 0) pdf.addPage([width, height], orientation);
          pdf.addImage(imgData, "PNG", 0, 0, width, height);
        });

        pdf.save("tangihanga-template.pdf");
        parent.postMessage({ type: "done" }, "*");
      }
    });

    parent.postMessage({ type: "pdf-frame-ready" }, "*");
  </script>
</body>
</html>



