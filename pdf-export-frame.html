<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Export Frame</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    .page {
      page-break-after: always;
    }
    .landscape {
      width: 297mm;
      height: 210mm;
    }
    .portrait {
      width: 210mm;
      height: 297mm;
    }
  </style>
</head>
<body>
  <script>
    let htmlPages = [];

    window.addEventListener("message", async (event) => {
      const { type, html, pageId, orientation } = event.data;

      console.log("üì© Received:", type);

      if (type === "ping") {
        parent.postMessage({ type: "pdf-frame-ready" }, "*");
      }

      else if (type === "renderContent") {
        console.log(`üñºÔ∏è Rendering ${pageId} (${orientation})`);
        htmlPages.push({ html, orientation });

        // Show current HTML
        document.body.innerHTML = html;

        // Wait before requesting next page
        await new Promise(r => setTimeout(r, 1000));
        parent.postMessage({ type: "next-page" }, "*");
      }

      else if (type === "render-complete") {
        console.log("üì¶ Rendering complete. Compiling PDF‚Ä¶");

        const container = document.createElement("div");

        htmlPages.forEach(page => {
          const div = document.createElement("div");
          div.className = `page ${page.orientation}`;
          div.innerHTML = page.html;
          container.appendChild(div);
        });

        document.body.innerHTML = "";
        document.body.appendChild(container);

        try {
          const opt = {
            margin: 0,
            filename: "Tangihanga_Template.pdf",
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
          };

          await html2pdf().from(container).set(opt).save();
          parent.postMessage({ type: "done" }, "*");
        } catch (err) {
          console.error("‚ùå PDF generation error:", err);
          parent.postMessage({ type: "done" }, "*");
        }
      }
    });
  </script>
</body>
</html>
