<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>PDF Export Renderer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        background: #111;
        color: white;
        overflow-x: hidden;
      }
      .preview-page {
        width: 794px;
        height: 1123px;
        margin: 40px auto;
        background: white;
        color: black;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
        overflow: hidden;
      }
      #downloadBtn {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="previewContainer"></div>

    <script>
      const { jsPDF } = window.jspdf;
      const pages = [];
      const pageOrder = ["cover", "order", "back"];
      let currentIndex = 0;

      window.addEventListener("message", async (event) => {
        const { type, html, pageId } = event.data || {};

        if (type === "renderContent" && pageId && html) {
          const wrapper = document.createElement("div");
          wrapper.className = "preview-page";
          wrapper.innerHTML = html;
          wrapper.dataset.pageId = pageId;
          document.getElementById("previewContainer").appendChild(wrapper);
        }

        if (type === "render-complete") {
          const pdf = new jsPDF({ orientation: "portrait", unit: "px", format: [794, 1123] });
          const pageEls = document.querySelectorAll(".preview-page");

          for (let i = 0; i < pageEls.length; i++) {
            const canvas = await html2canvas(pageEls[i], { scale: 2, useCORS: true });
            const imgData = canvas.toDataURL("image/png");
            if (i > 0) pdf.addPage();
            pdf.addImage(imgData, "PNG", 0, 0, 794, 1123);
          }

          pdf.save("tangihanga-template.pdf");
          parent.postMessage({ type: "done" }, "*");
        }

        if (type === "request-screenshot") {
          parent.postMessage({ type: "next-page" }, "*");
        }
      });

      window.onload = () => {
        parent.postMessage({ type: "pdf-frame-ready" }, "*");
      };
    </script>
  </body>
</html>



